<project default="build">
	<property file="build.properties"/>
	<property name="distdir" value="${basedir}/../dist/android"/>
	<property name="classesdir" value="${distdir}/classes"/>
	<property name="build.version" value="1.0.0"/>
	
	<property name="android.sdk" value="/opt/android-sdk"/>
	<property name="android.platform" value="${android.sdk}/platforms/android-1.6"/>
	<property name="google.apis" value="${android.sdk}/add-ons/addon_google_apis_google_inc_4"/>
	<available property="distdir-available" file="${distdir}"/>
	
	<path id="android">
		<pathelement path="${android.platform}/android.jar"/>
		<pathelement path="${google.apis}/libs/maps.jar"/>
	</path>

	<path id="titanium">
		<pathelement path="${classesdir}/titanium"/>
		<fileset dir="titanium/lib" includes="**/*.jar"/>
	</path>

	<target name="build-titanium" depends="clean">
		<mkdir dir="${classesdir}/titanium"/>
		<javac destdir="${classesdir}/titanium"
			classpathref="android"
			includes="**/*"
			source="1.5"
      debug="true"
			includeantruntime="false">

			<src path="titanium/src"/>
			<src path="titanium/thirdparty"/>
			
			<classpath>
				<fileset dir="titanium">
					<include name="lib/**/*.jar"/>
				</fileset>
			</classpath>
		</javac>

		<propertyfile file="${classesdir}/titanium/org/appcelerator/titanium/build.properties"
			comment="Generated by Titanium">
			<entry key="build.version" value="${build.version}"/>
			<entry key="build.timestamp" type="date" value="now"/>
		</propertyfile>
		<copy todir="${classesdir}/titanium">
			<fileset dir="titanium/src">
				<include name="**/*"/>
				<exclude name="**/*.java"/>
			</fileset>
			<fileset dir="titanium/thirdparty">
				<include name="**/*"/>
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
		<jar destfile="${distdir}/titanium.jar" basedir="${classesdir}/titanium"/>
	</target>
	
	<target name="build" depends="build-titanium">
		<build-module name="accelerometer"/>
		<build-module name="analytics"/>
		<build-module name="app"/>
		<build-module name="api"/>
		<build-module name="database"/>
		<build-module name="facebook"/>
		<build-module name="filesystem"/>
		<build-module name="geolocation"/>
		<build-module name="json"/>
		<build-module name="map"/>
		<build-module name="platform"/>
		<build-module name="utils"/>
		<build-module name="xml"/>
		<build-module name="yahoo"/>
		
		<build-module name="media">
			<classpath path="${classesdir}/filesystem"/>
		</build-module>

		<build-module name="ui">
			<classpath path="${classesdir}/filesystem"/>
			<classpath path="${classesdir}/app"/>
			<classpath path="${classesdir}/api"/>
			<classpath path="${classesdir}/media"/>
		</build-module>

		<build-module name="gesture">
			<classpath path="${classesdir}/ui"/>
		</build-module>

		<build-module name="network">
			<classpath path="${classesdir}/xml"/>
		</build-module>
	</target>

	<target name="clean" if="distdir-available">
		<delete includeemptydirs="true">
			<fileset dir="${distdir}" includes="**/*" defaultexcludes="false"/>
		</delete>
	</target>

	<macrodef name="build-module">
		<attribute name="name"/>
		<attribute name="prefix" default="modules/"/>
		<element name="extra-classpath" implicit="yes" optional="yes"/>
		<sequential>
			<mkdir dir="${classesdir}/@{name}"/>
			<javac srcdir="@{prefix}@{name}/src"
				destdir="${classesdir}/@{name}"
				includes="**/*"
				source="1.5"
				debug="true"
				includeantruntime="false">

				<extra-classpath/>
				<classpath refid="android"/>
				<classpath refid="titanium"/>
				<classpath>
					<fileset dir="@{prefix}@{name}">
						<include name="lib/**/*.jar"/>
					</fileset>
				</classpath>
			</javac>
			<copy todir="${classesdir}/@{name}">
				<fileset dir="@{prefix}@{name}/src">
					<include name="**/*"/>
					<exclude name="**/*.java"/>
				</fileset>
			</copy>
			<jar destfile="${distdir}/titanium-@{name}.jar" basedir="${classesdir}/@{name}"/>
		</sequential>
	</macrodef>
</project>
